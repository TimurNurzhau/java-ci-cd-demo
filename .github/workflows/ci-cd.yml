name: Java CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  ARTIFACT_NAME: java-calculator-app

jobs:
  build-and-test:
    name: Build and Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java-version: [11, 17]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn -B clean compile

      - name: Run unit tests
        run: mvn -B test
        env:
          CI: true

      - name: Generate test report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: JUnit Test Report
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}-java${{ matrix.java-version }}
          path: |
            target/surefire-reports/
            target/failsafe-reports/
          retention-days: 7

  package:
    name: Create Application Package
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build JAR package
        run: mvn -B clean package -DskipTests

      - name: Display JAR info
        run: |
          ls -la target/*.jar
          java -jar target/*.jar --version || echo "JAR created successfully"

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: target/*.jar
          retention-days: 30

  deploy-demo:
    name: Deploy Demonstration
    runs-on: ubuntu-latest
    needs: package
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}

      - name: Display deployment info
        run: |
          echo "ðŸš€ Deployment Simulation"
          echo "Application: Calculator"
          echo "Branch: ${{ github.ref }}"
          echo "JAR Files:"
          ls -la *.jar
          echo "Deployment would happen here to production"

      - name: Simulate deployment commands
        run: |
          echo "ðŸ“¦ Simulating deployment process..."
          echo "1. Uploading JAR to server..."
          echo "2. Stopping previous version..."
          echo "3. Starting new version..."
          echo "âœ… Deployment simulation completed successfully"

      - name: Create deployment tag
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_tag: "deploy-$(date +%Y%m%d-%H%M%S)"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security audit
        run: |
          echo "ðŸ”’ Running security checks..."
          mvn -B dependency:tree
          echo "Security scan completed"